# Android消息机制

##### 简介：

Android的应用程序和Windows应用程序一样，都是由消息驱动的。在Android操作系统中，谷歌也实现了消息循环处理机制。

##### 相关概念：

* Message
  Message（消息）代表一个行为或者一串动作，每一个消息在加入消息队列\(MessageQueue\)时，都有明确的目标\(Handler\)
* MessageQueue
  MessageQueue（消息队列）以队列的形式存放Message，先进先出原则
* Looper
  它负责从消息队列中循环取出消息给Handler
* Handler
  消息的真正处理者，具备获取消息，发送消息，处理消息，移除消息等功能

Android是一个基于Linux的系统，底层用C、C++实现的，而且还有NDK的存在，Android消息驱动的模型为了消息的及时性、高效性，在Native层设计了Java层对应的类如Looper、MessageQueue等。查看下图:

![](https://raw.githubusercontent.com/wangkuiwu/android_applets/master/os/pic/messagequeue/message_queue01.jpg)

## 总结

1. 不阻塞主线程

   Android应用程序启动时，系统会创建一个主线程，负责与UI组件（widget、view）进行交互，比如控制UI界面界面显示、更新等；分发事件给UI界面处理，比如按键事件、触摸事件、屏幕绘图事件等，因此，Android主线程也称为UI线程。

   由此可知，UI线程只能处理一些简单的、短暂的操作，如果要执行繁重的任务或者耗时很长的操作，比如访问网络、数据库、下载等，这种单线程模型会导致线程运行性能大大降低，甚至阻塞UI线程，如果被阻塞超过5秒，系统会提示应用程序无相应对话框，缩写为ANR，导致退出整个应用程序或者短暂杀死应用程序。 

   _**Android系统将大部分耗时、繁重任务交给子线程完成，不会在主线程中完成。**_

2. 并发程序设计的有序性

   单线程模型的UI主线程也是不安全的，会造成不可确定的结果。

   线程不安全简单理解为：多线程访问资源时，有可能出现多个线程先后更改数据造成数据不一致。比如，A工作线程（也称为子线程）访问某个公共UI资源，B工作线程在某个时候也访问了该公共资源，当B线程正访问时，公共资源的属性已经被A改变了，这样B得到的结果不是所需要的的，造成了数据不一致的混乱情况。

   线程安全简单理解为：当一个线程访问功能资源时，对该资源进程了保护，比如加了锁机制，当前线程在没有访问结束释放锁之前，其他线程只能等待直到释放锁才能访问，这样的线程就是安全的。 

   _**Android只允许主线程更新UI界面，子线程处理后的结果无法和主线程交互，即无法直接访问主线程，这就要用到Handler机制来解决此问题。基于Handler机制，在子线程先获得Handler对象，该对象将数据发送到主线程消息队列，主线程通过Loop循环获取消息交给Handler处理。**_



